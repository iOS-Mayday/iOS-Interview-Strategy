æ‰€æœ‰çš„è¯­è¨€éƒ½ä¼šæ¶‰åŠå¹¶å‘ç¼–ç¨‹ï¼Œå¹¶å‘å°±æ˜¯å¤šä¸ªä»»åŠ¡åŒæ—¶è¿è¡Œï¼Œè¿™ä¹Ÿå‡ ä¹æ˜¯æ‰€æœ‰è¯­è¨€æœ€éš¾çš„åœ°æ–¹ã€‚iOS å¼€å‘ä¸­ï¼Œå¹¶å‘ç¼–ç¨‹ä¸»è¦ç”¨äºæå‡ App çš„è¿è¡Œæ€§èƒ½ï¼Œä¿è¯Appå®æ—¶å“åº”ç”¨æˆ·çš„æ“ä½œã€‚å…¶ä¸­æˆ‘ä»¬æ—¥å¸¸æ“ä½œçš„ UI ç•Œé¢å°±æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¹‹ä¸Šï¼Œæ˜¯ä¸€ä¸ªä¸²è¡Œçº¿ç¨‹ã€‚å¦‚æœæˆ‘ä»¬å°†æ‰€æœ‰çš„ä»£ç æ”¾åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹å°†æ‰¿æ‹…ç½‘ç»œè¯·æ±‚ã€æ•°æ®å¤„ç†ã€å›¾åƒæ¸²æŸ“ç­‰å„ç§æ“ä½œï¼Œæ— è®ºæ˜¯ GPU è¿˜æ˜¯å†…å­˜éƒ½ä¼šæ€§èƒ½è€—å°½ï¼Œä»è€Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

![](https://upload-images.jianshu.io/upload_images/22877992-f318cd42c46c1e81.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æœ¬ç« å°†ä»å¹¶å‘ç¼–ç¨‹çš„ç†è®ºè¯´èµ·ï¼Œé‡ç‚¹å…³æ³¨ GCD å’Œ Operationsâ€”â€”iOS å¼€å‘ä¸­æœ€ä¸»è¦çš„å¤„ç†å¹¶å‘ç¼–ç¨‹çš„ä¸¤å¥— APIã€‚é™¤äº†ç†è®ºï¼Œå®æˆ˜éƒ¨åˆ†å°†æ¶‰åŠå¦‚ä½•å°†å¹¶å‘ç¼–ç¨‹è¿ç”¨åœ¨å®é™… App å¼€å‘ä¸­ã€‚æœ€åï¼Œæœ¬ç« å°†æ¶‰åŠå¦‚ä½• debug å¹¶å‘ç¼–ç¨‹çš„é—®é¢˜ï¼šåŒ…æ‹¬å¦‚ä½•è§‚å¯Ÿåœ¨ Xcode ä¸­è§‚å¯Ÿçº¿ç¨‹ä¿¡æ¯ã€å¦‚ä½•å‘ç°å¹¶è§£å†³ç¼–ç¨‹ä¸­çš„å¹¶å‘é—®é¢˜ã€‚

### 1.iOS å¼€å‘ä¸­å¯¹äºå¹¶å‘æ“ä½œæœ‰å“ªä¸‰ç§æ–¹å¼ï¼Ÿ

å…³é”®è¯ï¼š#NSThread #GCD #Operations

åœ¨ iOS å¼€å‘ä¸­ï¼ŒåŸºæœ¬æœ‰ 3 ç§æ–¹å¼å®ç°å¤šçº¿ç¨‹ï¼š

*   **NSThread**Â å¯ä»¥æœ€å¤§é™åº¦çš„æŒæ§æ¯ä¸€ä¸ªçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚ä½†æ˜¯åŒæ—¶ä¹Ÿéœ€è¦å¼€å‘è€…æ‰‹åŠ¨ç®¡ç†æ‰€æœ‰çš„çº¿ç¨‹æ´»åŠ¨ï¼Œæ¯”å¦‚åˆ›å»ºã€åŒæ­¥ã€æš‚åœã€å–æ¶ˆç­‰ç­‰ï¼Œå…¶ä¸­æ‰‹åŠ¨åŠ é”æ“ä½œæŒ‘æˆ˜æ€§å¾ˆé«˜ã€‚æ€»ä½“ä½¿ç”¨åœºæ™¯å¾ˆå°ï¼ŒåŸºæœ¬æ˜¯é€ è½®å­æˆ–æ˜¯æµ‹è¯•æ—¶ä½¿ç”¨ã€‚

*   **GCDï¼ˆGrand Central Dispatchï¼‰**Â æ˜¯ Apple æ¨èçš„æ–¹å¼ï¼Œå®ƒå°†çº¿ç¨‹ç®¡ç†æ¨ç»™äº†ç³»ç»Ÿï¼Œç”¨çš„æ˜¯åä¸º dispatch queue çš„é˜Ÿåˆ—ã€‚å¼€å‘è€…åªè¦å®šä¹‰æ¯ä¸ªçº¿ç¨‹éœ€è¦æ‰§è¡Œçš„å·¥ä½œå³å¯ã€‚æ‰€æœ‰çš„å·¥ä½œéƒ½æ˜¯å…ˆè¿›å…ˆå‡ºï¼Œæ¯ä¸€ä¸ª block è¿è½¬é€Ÿåº¦æå¿«ï¼ˆçº³ç§’çº§åˆ«ï¼‰ã€‚ä½¿ç”¨åœºæ™¯ä¸»è¦æ˜¯ä¸ºäº†è¿½æ±‚é«˜æ•ˆå¤„ç†å¤§é‡å¹¶å‘æ•°æ®ï¼Œå¦‚å›¾ç‰‡å¼‚æ­¥åŠ è½½ã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚

*   **Operations**Â ä¸ GCD ç±»ä¼¼ã€‚è™½ç„¶æ˜¯ OperationQueue é˜Ÿåˆ—å®ç°ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å±€é™äºå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—æ“ä½œã€‚å®ƒæä¾›äº†å¤šä¸ªæ¥å£å¯ä»¥å®ç°æš‚åœã€ç»§ç»­ã€ç»ˆæ­¢ã€ä¼˜å…ˆé¡ºåºã€ä¾èµ–ç­‰å¤æ‚æ“ä½œï¼Œæ¯” GCD æ›´åŠ çµæ´»ã€‚åº”ç”¨åœºæ™¯æœ€å¹¿ï¼Œæ•ˆç‡ä¸Šæ¯ä¸ª Operation å¤„ç†é€Ÿåº¦è¾ƒå¿«ï¼ˆæ¯«ç§’çº§åˆ«ï¼‰ï¼Œå‡ ä¹æ‰€æœ‰çš„åŸºæœ¬çº¿ç¨‹æ“ä½œéƒ½å¯ä»¥å®ç°ã€‚

### 2.è¯•æ¯”è¾ƒä»¥ä¸‹å…³é”®è¯ï¼šSerial, Concurrent, Sync, Asyncï¼Ÿ

**å…³é”®è¯ï¼š#å¤šä»»åŠ¡ #é˜»å¡çº¿ç¨‹**

è¿™ 4 ä¸ªå…³é”®è¯ï¼Œå‰ä¸¤ä¸ª Serial/Concurrent æ„æˆä¸€å¯¹ï¼Œåä¸¤ä¸ª Sync/Async æ„æˆä¸€å¯¹ã€‚æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ï¼š

*   **Serial/Concurrent**Â å£°æ˜é˜Ÿåˆ—çš„å±æ€§æ˜¯ä¸²è¡Œè¿˜æ˜¯å¹¶å‘ã€‚ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Queueï¼‰æŒ‡é˜Ÿåˆ—ä¸­åŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œå½“å‰ä»»åŠ¡æ‰§è¡Œå®Œåæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œåœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent Queueï¼‰å…è®¸å¤šä¸ªä»»åŠ¡åœ¨åŒä¸€ä¸ªæ—¶é—´åŒæ—¶è¿›è¡Œï¼Œåœ¨å¹¶å‘é˜Ÿåˆ—ä¸­æœ‰å¤šä¸ªçº¿ç¨‹ã€‚ä¸²è¡Œé˜Ÿåˆ—çš„ä»»åŠ¡ä¸€å®šæ˜¯æŒ‰å¼€å§‹çš„é¡ºåºç»“æŸï¼Œè€Œå¹¶å‘é˜Ÿåˆ—çš„ä»»åŠ¡å¹¶ä¸ä¸€å®šä¼šæŒ‰ç…§å¼€å§‹çš„é¡ºåºè€Œç»“æŸã€‚

*   **Sync/Async**Â è¡¨æ˜ä»»åŠ¡æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥æ‰§è¡Œã€‚åŒæ­¥ï¼ˆSyncï¼‰ä¼šæŠŠå½“å‰çš„ä»»åŠ¡åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œé™¤éç­‰åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œçº¿ç¨‹æ‰ä¼šè¿”å›ç»§ç»­è¿è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´åŒæ­¥ä¼šé˜»å¡çº¿ç¨‹ã€‚å¼‚æ­¥ï¼ˆAsyncï¼‰ä¹Ÿä¼šæŠŠå½“å‰çš„ä»»åŠ¡åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œä½†å®ƒä¼šç«‹åˆ»è¿”å›ï¼Œæ— éœ€ç­‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œä¹Ÿå°±æ˜¯è¯´å¼‚æ­¥ä¸ä¼šé˜»å¡çº¿ç¨‹ã€‚

*   æ— è®ºæ˜¯ä¸²è¡Œè¿˜æ˜¯å¹¶å‘é˜Ÿåˆ—éƒ½å¯ä»¥æ‰§è¡Œæ‰§è¡ŒåŒæ­¥æˆ–å¼‚æ­¥æ“ä½œã€‚æ³¨æ„åœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸Šæ‰§è¡ŒåŒæ­¥æ“ä½œå®¹æ˜“é€ æˆæ­»é”ï¼Œåœ¨å¹¶å‘é˜Ÿåˆ—ä¸Šåˆ™ä¸ç”¨æ‹…å¿ƒã€‚å¼‚æ­¥æ“ä½œæ— è®ºå®åœ¨ä¸²è¡Œé˜Ÿåˆ—è¿˜æ˜¯å¹¶å‘é˜Ÿåˆ—ä¸Šéƒ½å¯èƒ½å‡ºç°ç«æ€æ¡ä»¶çš„é—®é¢˜ï¼›åŒæ—¶å¼‚æ­¥æ“ä½œç»å¸¸ä¸é€ƒé€¸é—­åŒ…ä¸€èµ·å‡ºç°åœ¨ API çš„è®¾è®¡å½“ä¸­ã€‚

### 3.ä»£ç å®æˆ˜ï¼šä»¥ä¸‹ä»£ç å‡åœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸­å‘ç”Ÿï¼Œæ‰§è¡Œä¹‹åä¼šæ‰“å°å‡ºä»€ä¹ˆï¼Ÿ

**å…³é”®è¯ï¼š#ä¸²è¡Œ #åŒæ­¥ #å¼‚æ­¥**

```
// ä¸²è¡ŒåŒæ­¥
serialQueue.sync {
  print(1)
}
print(2)
serialQueue.sync {
  print(3)
}
print(4)

// ä¸²è¡Œå¼‚æ­¥
serialQueue.async {
  print(1)
}
print(2)
serialQueue.async {
  print(3)
}
print(4)

// ä¸²è¡Œå¼‚æ­¥ä¸­åµŒå¥—åŒæ­¥
print(1)
serialQueue.async {
  print(2)
  serialQueue.sync {
    print(3)
  }
  print(4)
}
print(5)

// ä¸²è¡ŒåŒæ­¥ä¸­åµŒå¥—å¼‚æ­¥
print(1)
serialQueue.sync {
  print(2)
  serialQueue.async {
    print(3)
  }
  print(4)
}
print(5)

```

é¦–å…ˆï¼Œåœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸Šè¿›è¡ŒåŒæ­¥æ“ä½œï¼Œæ‰€æœ‰ä»»åŠ¡å°†é¡ºåºå‘ç”Ÿï¼Œæ‰€ä»¥ç¬¬ä¸€æ®µçš„æ‰“å°ç»“æœä¸€å®šæ˜¯ 1234ï¼›

å…¶æ¬¡ï¼Œåœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸Šè¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œæ­¤æ—¶ä»»åŠ¡å®Œæˆçš„é¡ºåºå¹¶ä¸ä¿è¯ã€‚æ‰€ä»¥å¯èƒ½ä¼šæ‰“å°å‡ºè¿™å‡ ç§ç»“æœï¼š1234 ï¼Œ2134ï¼Œ1243ï¼Œ2413ï¼Œ2143ã€‚æ³¨æ„ 1 ä¸€å®šåœ¨ 3 ä¹‹å‰æ‰“å°å‡ºæ¥ï¼Œå› ä¸ºå‰è€…åœ¨åè€…ä¹‹å‰æ´¾å‘ï¼Œä¸²è¡Œé˜Ÿåˆ—ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥ä¸€æ—¦æ´¾å‘å®Œæˆå°±æ‰§è¡Œã€‚åŒç† 2 ä¸€å®šåœ¨ 4 ä¹‹å‰æ‰“å°ï¼Œ2 ä¸€å®šåœ¨ 3 ä¹‹å‰æ‰“å°ã€‚

æ¥ç€ï¼Œå¯¹åŒä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ä¸­è¿›è¡Œå¼‚æ­¥ã€åŒæ­¥åµŒå¥—ã€‚è¿™é‡Œä¼šæ„æˆæ­»é”ï¼Œæ‰€ä»¥åªä¼šæ‰“å°å‡º 125 æˆ–è€… 152ã€‚

æœ€åï¼Œåœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸­è¿›è¡ŒåŒæ­¥ã€å¼‚æ­¥åµŒå¥—ï¼Œä¸ä¼šæ„æˆæ­»é”ã€‚è¿™é‡Œä¼šæ‰“å°å‡º 3 ä¸ªç»“æœï¼š12345ï¼Œ12435ï¼Œ12453ã€‚è¿™é‡Œ1ä¸€å®šåœ¨æœ€å‰ï¼Œ2 ä¸€å®šåœ¨ 4 å‰ï¼Œ4 ä¸€å®šåœ¨ 5 å‰ã€‚

### 4.ä»£ç å®æˆ˜ï¼šä»¥ä¸‹ä»£ç å‡åœ¨å¹¶å‘é˜Ÿåˆ—ä¸­å‘ç”Ÿï¼Œæ‰§è¡Œä¹‹åä¼šæ‰“å°å‡ºä»€ä¹ˆï¼Ÿ

**å…³é”®è¯ï¼š#å¹¶å‘ #åŒæ­¥ #å¼‚æ­¥**

```
// å¹¶å‘åŒæ­¥
concurrentQueue.sync {
  print(1)
}
print(2)
concurrentQueue.sync {
  print(3)
}
print(4)

// å¹¶å‘å¼‚æ­¥
concurrentQueue.async {
  print(1)
}
print(2)
concurrentQueue.async {
  print(3)
}
print(4)

// å¹¶å‘å¼‚æ­¥ä¸­åµŒå¥—åŒæ­¥
print(1)
concurrentQueue.async {
  print(2)
  concurrentQueue.sync {
    print(3)
  }
  print(4)
}
print(5)

// å¹¶å‘åŒæ­¥ä¸­åµŒå¥—å¼‚æ­¥
print(1)
concurrentQueue.sync {
  print(2)
  concurrentQueue.async {
    print(3)
  }
  print(4)
}
print(5)

```

å¦‚æœä½ æ­£åœ¨è·³æ§½æˆ–è€…æ­£å‡†å¤‡è·³æ§½ä¸å¦¨åŠ¨åŠ¨å°æ‰‹ï¼Œæ·»åŠ ä¸€ä¸‹å’±ä»¬çš„äº¤æµç¾¤[**931 542 608**](https://jq.qq.com/?_wv=1027&k=cfVxrMAH)æ¥è·å–ä¸€ä»½è¯¦ç»†çš„å¤§å‚é¢è¯•èµ„æ–™ä¸ºä½ çš„è·³æ§½å¤šæ·»ä¸€ä»½ä¿éšœã€‚

é¦–å…ˆï¼Œåœ¨å¹¶å‘é˜Ÿåˆ—ä¸Šè¿›è¡ŒåŒæ­¥æ“ä½œï¼Œæ‰€æœ‰ä»»åŠ¡å°†é¡ºåºæ‰§è¡Œã€é¡ºåºå®Œæˆï¼Œæ‰€ä»¥ç¬¬ä¸€æ®µçš„æ‰“å°ç»“æœä¸€å®šæ˜¯ 1234ï¼›

å…¶æ¬¡ï¼Œåœ¨å¹¶å‘é˜Ÿåˆ—ä¸Šè¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œå› ä¸ºå¹¶å‘å¯¹åˆ—æœ‰å¤šä¸ªçº¿ç¨‹ ã€‚æ‰€ä»¥è¿™é‡Œåªèƒ½ä¿è¯ 24 é¡ºåºæ‰§è¡Œï¼Œ13 ä¹±åºï¼Œå¯èƒ½æ’åœ¨ä»»æ„ä½ç½®ï¼š1234ï¼Œ1243ï¼Œ2413 ï¼Œ2431ï¼Œ2143ï¼Œ2341ï¼Œ2134ï¼Œ2314ã€‚

æ¥ç€ï¼Œå¯¹åŒä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ä¸­è¿›è¡Œå¼‚æ­¥ã€åŒæ­¥åµŒå¥—ã€‚è¿™é‡Œä¸ä¼šæ„æˆæ­»é”ï¼Œå› ä¸ºåŒæ­¥æ“ä½œåªä¼šé˜»å¡ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œå¹¶å‘é˜Ÿåˆ—å¯¹åº”å¤šä¸ªçº¿ç¨‹ã€‚è¿™é‡Œä¼šæ‰“å°å‡º 4 ä¸ªç»“æœï¼š12345ï¼Œ12534ï¼Œ12354ï¼Œ15234ã€‚æ³¨æ„åŒæ­¥æ“ä½œä¿è¯äº† 3 ä¸€å®šä¼šåœ¨ 4 ä¹‹å‰æ‰“å°å‡ºæ¥ã€‚

æœ€åï¼Œåœ¨å¹¶å‘é˜Ÿåˆ—ä¸­è¿›è¡ŒåŒæ­¥ã€å¼‚æ­¥åµŒå¥—ï¼Œä¸ä¼šæ„æˆæ­»é”ã€‚è€Œä¸”ç”±äºæ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œæ‰€ä»¥åœ¨è¿è¡Œå¼‚æ­¥æ“ä½œæ—¶ä¹ŸåŒæ—¶ä¼šè¿è¡Œå…¶ä»–æ“ä½œã€‚è¿™é‡Œä¼šæ‰“å°å‡º 3 ä¸ªç»“æœï¼š12345ï¼Œ12435ï¼Œ12453ã€‚è¿™é‡ŒåŒæ­¥æ“ä½œä¿è¯äº† 2 å’Œ 4 ä¸€å®šåœ¨ 3 å’Œ 5 ä¹‹å‰æ‰“å°å‡ºæ¥ã€‚

### 5.ä¸¾ä¾‹è¯´æ˜ iOS å¹¶å‘ç¼–ç¨‹ä¸­çš„ä¸‰å¤§é—®é¢˜ï¼Ÿ

**å…³é”®è¯ï¼š#ç«æ€æ¡ä»¶ #ä¼˜å…ˆå€’ç½® #æ­»é”é—®é¢˜**

åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œä¸€èˆ¬ä¼šé¢å¯¹è¿™æ ·çš„ä¸‰ä¸ªé—®é¢˜ï¼šç«æ€æ¡ä»¶ã€ä¼˜å…ˆå€’ç½®ã€æ­»é”é—®é¢˜ã€‚é’ˆå¯¹ iOS å¼€å‘ï¼Œå®ƒä»¬çš„å…·ä½“å®šä¹‰ä¸ºï¼š

*   **ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰**ã€‚æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçº¿ç¨‹å¯¹å…±äº«çš„æ•°æ®è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œæœ€ç»ˆçš„æ•°æ®ç»“æœä¸ç¡®å®šçš„æƒ…å†µã€‚ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š

```
var num = 0
DispatchQueue.global().async {
  for _ in 1â€¦10000 {
    num += 1
  }
}

for _ in 1â€¦10000 {
  num += 1
}

```

æœ€åçš„è®¡ç®—ç»“æœ num å¾ˆæœ‰å¯èƒ½å°äº 20000ï¼Œå› ä¸ºå…¶æ“ä½œä¸ºéåŸå­æ“ä½œã€‚åœ¨ä¸Šè¿°ä¸¤ä¸ªçº¿ç¨‹å¯¹numè¿›è¡Œè¯»å†™æ—¶å…¶å€¼ä¼šéšç€è¿›ç¨‹æ‰§è¡Œé¡ºåºçš„ä¸åŒè€Œäº§ç”Ÿä¸åŒç»“æœã€‚

*   **ä¼˜å…ˆå€’ç½®ï¼ˆPriority Inverstionï¼‰**ã€‚æŒ‡ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼šå› ä¸ºå„ç§åŸå› å…ˆäºé«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰§è¡Œã€‚ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š

```
var highPriorityQueue = DispatchQueue.global(qos: .userInitiated)
var lowPriorityQueue = DispatchQueue.global(qos: .utility)

let semaphore = DispatchSemaphore(value: 1)

lowPriorityQueue.async {
  semaphore.wait()
  for i in 0...10 {
    print(i)
  }
  semaphore.signal()
}

highPriorityQueue.async {
  semaphore.wait()
  for i in 11...20 {
    print(i)
  }
  semaphore.signal()
}

```

ä¸Šè¿°ä»£ç å¦‚æœæ²¡æœ‰ semaphoreï¼Œé«˜ä¼˜å…ˆæƒçš„ highPriorityQueue ä¼šä¼˜å…ˆæ‰§è¡Œï¼Œæ‰€ä»¥ç¨‹åºä¼šä¼˜å…ˆæ‰“å°å®Œ 11 åˆ° 20ã€‚è€ŒåŠ äº† semaphore ä¹‹åï¼Œä½ä¼˜å…ˆæƒçš„ lowPriorityQueue ä¼šå…ˆæŒ‚èµ· semaphoreï¼Œé«˜ä¼˜å…ˆæƒçš„highPriorityQueue å°±åªæœ‰ç­‰ semaphore è¢«é‡Šæ”¾æ‰èƒ½å†æ‰§è¡Œæ‰“å°ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ä¼˜å…ˆæƒçš„çº¿ç¨‹å¯ä»¥é”ä¸ŠæŸç§é«˜ä¼˜å…ˆæƒçº¿ç¨‹éœ€è¦çš„èµ„æºï¼Œä»è€Œä¼˜äºè¿«ä½¿é«˜ä¼˜å…ˆæƒçš„çº¿ç¨‹ç­‰å¾…ä½ä¼˜å…ˆæƒçš„çº¿ç¨‹ï¼Œè¿™å°±å«åšä¼˜å…ˆå€’ç½®ã€‚

*   **æ­»é”é—®é¢˜ï¼ˆDead Lockï¼‰**ã€‚æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹ï¼Œå®ƒä»¬ä¹‹é—´äº’ç›¸ç­‰å¾…å½¼æ­¤åœæ­¢æ‰§è¡Œï¼Œä»¥è·å¾—æŸç§èµ„æºï¼Œä½†æ˜¯æ²¡æœ‰ä¸€æ–¹ä¼šæå‰é€€å‡ºçš„æƒ…å†µã€‚iOS ä¸­æœ‰ä¸ªç»å…¸çš„ä¾‹å­å°±æ˜¯ä¸¤ä¸ª Operation äº’ç›¸ä¾èµ–ï¼š

```
let operationA = Operation()
let operationB = Operation()

operationA.addDependency(operationB)
operationB.addDependency(operationA)

```

è¿˜æœ‰ä¸€ç§ç»å…¸çš„æƒ…å†µï¼Œå°±æ˜¯åœ¨å¯¹åŒä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ä¸­è¿›è¡Œå¼‚æ­¥ã€åŒæ­¥åµŒå¥—ï¼š

```
serialQueue.async {
  serialQueue.sync {
  }
}

```

å› ä¸ºä¸²è¡Œé˜Ÿåˆ—ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥é¦–å…ˆå®ƒä¼šæŠŠå¼‚æ­¥ block ä¸­çš„ä»»åŠ¡æ´¾å‘æ‰§è¡Œï¼Œå½“è¿›å…¥åˆ° block ä¸­æ—¶ï¼ŒåŒæ­¥æ“ä½œæ„å‘³ç€é˜»å¡å½“å‰é˜Ÿåˆ— ã€‚è€Œæ­¤æ—¶å¤–éƒ¨ block æ­£åœ¨ç­‰å¾…å†…éƒ¨ block æ“ä½œå®Œæˆï¼Œè€Œå†…éƒ¨block åˆé˜»å¡å…¶æ“ä½œå®Œæˆï¼Œå³å†…éƒ¨ block åœ¨ç­‰å¾…å¤–éƒ¨ block æ“ä½œå®Œæˆã€‚æ‰€ä»¥ä¸²è¡Œé˜Ÿåˆ—è‡ªå·±ç­‰å¾…è‡ªå·±é‡Šæ”¾èµ„æºï¼Œæ„æˆæ­»é”ã€‚è¿™ä¹Ÿæé†’äº†æˆ‘ä»¬ï¼Œåƒä¸‡ä¸è¦åœ¨ä¸»çº¿ç¨‹ä¸­ç”¨åŒæ­¥æ“ä½œã€‚

å¦‚æœä½ æ­£åœ¨è·³æ§½æˆ–è€…æ­£å‡†å¤‡è·³æ§½ä¸å¦¨åŠ¨åŠ¨å°æ‰‹ï¼Œæ·»åŠ ä¸€ä¸‹å’±ä»¬çš„äº¤æµç¾¤[**931 542 608**](https://jq.qq.com/?_wv=1027&k=cfVxrMAH)æ¥è·å–ä¸€ä»½è¯¦ç»†çš„å¤§å‚é¢è¯•èµ„æ–™ä¸ºä½ çš„è·³æ§½å¤šæ·»ä¸€ä»½ä¿éšœã€‚

### 6.ä»£ç å®æˆ˜ï¼šä»¥ä¸‹ä»£ç æœ‰ä»€ä¹ˆéšæ‚£ï¼Ÿ

**å…³é”®è¯ï¼š#ç«æ€æ¡ä»¶ #thread sanitizer**

```
func getUser(id: String) throws -> User {
  return try storage.getUser(id)
}

func setUser(_ user: User) throws {
  try storage.setUser(user)
}

```

ä¸Šé¢è¿™æ®µä»£ç çš„åŠŸèƒ½æ˜¯è¯»å†™ç”¨æˆ·ä¿¡æ¯ã€‚ä¹ä¸€çœ‹ä¸Šå»æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ä¸€æ—¦å¤šçº¿ç¨‹æ¶‰åŠåˆ°è¯»å†™ï¼Œå°±ä¼šäº§ç”Ÿç«æ€æ¡ä»¶ï¼ˆrace conditionï¼‰ã€‚è§£å†³æ–¹æ³•æ˜¯æ‰“å¼€Xcodeä¸­çš„çº¿ç¨‹æ£€æµ‹å·¥å…· thread sanitizerï¼ˆåœ¨ Xcode çš„scheme ä¸­å‹¾é€‰ Thread Sanitizer å³å¯ï¼‰ï¼Œå®ƒä¼šæ£€æµ‹å‡ºä»£ç ä¸­å‡ºç°ç«æ€æ¡ä»¶ä¹‹å¤„ï¼Œå¹¶æé†’æˆ‘ä»¬ä¿®æ”¹ã€‚

å¯¹äºè¯»å†™é—®é¢˜ï¼Œä¸€èˆ¬æœ‰ 3 ç§å¤„ç†æ–¹å¼ã€‚

ç¬¬ 1 ç§æ˜¯ç”¨ä¸²è¡Œé˜Ÿåˆ—ï¼Œæ— è®ºè¯»å†™ï¼ŒåŒä¸€æ—¶é—´åªèƒ½åšä¸€ä¸ªæ“ä½œï¼Œè¿™æ ·å°±ä¿è¯äº†é˜Ÿåˆ—çš„å®‰å…¨ã€‚å…¶ç¼ºç‚¹æ˜¯é€Ÿåº¦æ…¢ï¼Œå°¤å…¶æ˜¯åœ¨å¤§é‡è¯»å†™å‘ç”Ÿæ—¶ï¼Œæ¯æ¬¡åªèƒ½åšå•ä¸ªè¯»æˆ–å†™æ“ä½œçš„æ•ˆç‡å®åœ¨å¤ªä½ã€‚ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š

```
func getUser(id: String) throws -> User {
  return serialQueue.sync {
    return try storage.getUser(id)
  }
}
func setUser(_ user: User) throws {
  try serialQueue.sync {
    try storage.setUser(user)
  }
}

```

ç¬¬ 2 ç§æ˜¯ç”¨å¹¶å‘é˜Ÿåˆ—é…åˆå¼‚æ­¥æ“ä½œå®Œæˆã€‚å¼‚æ­¥æ“ä½œç”±äºä¼šç›´æ¥è¿”å›ï¼Œæ‰€ä»¥å¿…é¡»é…åˆé€ƒé€¸é—­åŒ…æ¥ä¿è¯åç»­æ“ä½œçš„åˆæ³•æ€§ã€‚

```
enum Result<T> {
  case value(T)
  case error(Error)
}

func getUser(id: String, completion: @escaping (Result<User>) -> Void) {
  try serialQueue.async {
    do {
      user = try storage.getUser(id)
      completion(.value(user))
    } catch {
      completion(.error(error))
    }
  }
}

func setUser(_ user: User, completion: @escaping (Result<()>) -> Void) {
  try serialQueue.async {
    do {
      try storage.setUser(user)
      completion(.value(())
    } catch {
      completion(.error(error))
    }
  }
}

```

ç¬¬ 3 ç§æ–¹æ³•æ˜¯ç”¨å¹¶å‘é˜Ÿåˆ—ï¼Œè¯»æ“ä½œæ—¶ç”¨ sync ç›´æ¥è¿”å›ç»“æœï¼Œå†™æ“ä½œæ—¶ç”¨ barrier flag æ¥ä¿è¯æ­¤æ—¶å¹¶å‘é˜Ÿåˆ—åªè¿›è¡Œå½“å‰çš„å†™æ“ä½œï¼ˆç±»ä¼¼å°†å¹¶å‘é˜Ÿåˆ—æš‚æ—¶è½¬ä¸ºä¸²è¡Œé˜Ÿåˆ—ï¼‰ï¼Œè€Œæ— è§†å…¶ä»–æ“ä½œã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```
enum Result<T> {
  case value(T)
  case error(Error)
}

func getUser(id: String) throws -> User {
  var user: User!
  try concurrentQueue.sync {
    user = try storage.getUser(id)
  }

  return user
}

func setUser(_ user: User, completion: @escaping (Result<()>) -> Void) {
  try concurrentQueue.async(flags: .barrier) {
    do {
      try storage.setUser(user)
      completion(.value(())
    } catch {
      completion(.error(error))
    }
  }
}

```

### 7.è¯•æ¯”è¾ƒä»¥ä¸‹ GCD ä¸­çš„æ–¹æ³• dispatch_async, dispatch_after, dispatch_once, dispatch_group

**å…³é”®è¯ï¼š#å¼‚æ­¥ #å»¶æ—¶ #å•ä¾‹ #çº¿ç¨‹åŒæ­¥**

é¦–å…ˆè¦æ˜ç¡®ï¼Œè¿™å‡ ä¸ªå…³é”®è¯éƒ½æ˜¯ Objective-C ç¼–ç¨‹ä¸­å‡ºç°çš„ã€‚å®ƒä»¬åˆ†åˆ«æœ‰å¦‚ä¸‹ç”¨æ³•ï¼š

*   dispatch_async ç”¨äºå¯¹æŸä¸ªçº¿ç¨‹è¿›è¡Œå¼‚æ­¥æ“ä½œã€‚å¼‚æ­¥æ“ä½œå¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸é˜»å¡çº¿ç¨‹çš„æƒ…å†µä¸‹å……åˆ†åˆ©ç”¨ä¸åŒçº¿ç¨‹å’Œé˜Ÿåˆ—æ¥å¤„ç†ä»»åŠ¡ã€‚ä¾‹å¦‚æˆ‘ä»¬éœ€è¦ä»ç½‘ç»œç«¯ä¸‹è½½å›¾ç‰‡ï¼Œç„¶åå°†å›¾ç‰‡èµ‹äºˆæŸä¸ª UIImageViewï¼Œå°±å¯ä»¥ç”¨åˆ° dispatch_async:

```
dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^{
  UIImage *image = [client fetchImageFromURL: url];
  dispatch_async(dispatch_get_main_queue(), ^{
    self.imageView.image = image;
  });
});

```

*   dispatch_after ä¸€èˆ¬ç”¨äºä¸»çº¿ç¨‹çš„å»¶æ—¶æ“ä½œã€‚ä¾‹å¦‚è¦å°†ä¸€ä¸ªé¡µé¢çš„å¯¼èˆªæ ‡é¢˜ç”±â€œç­‰å¾…â€ä¹‹å 2 ç§’æ”¹ä¸ºâ€œå®Œæˆâ€ï¼Œå¯ä»¥ç”¨ dispatch_after æ¥å®ç°ï¼š

```
self.title = @â€ç­‰å¾…â€;
double delayInSeconds = 2.0;
dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * NSEC_PER_SEC)); 
dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
  self.title = @â€å®Œæˆâ€;        
});

```

å¦‚æœä½ æ­£åœ¨è·³æ§½æˆ–è€…æ­£å‡†å¤‡è·³æ§½ä¸å¦¨åŠ¨åŠ¨å°æ‰‹ï¼Œæ·»åŠ ä¸€ä¸‹å’±ä»¬çš„äº¤æµç¾¤[**931 542 608**](https://jq.qq.com/?_wv=1027&k=cfVxrMAH)æ¥è·å–ä¸€ä»½è¯¦ç»†çš„å¤§å‚é¢è¯•èµ„æ–™ä¸ºä½ çš„è·³æ§½å¤šæ·»ä¸€ä»½ä¿éšœã€‚

*   dispatch_once ç”¨äºç¡®ä¿å•ä¾‹çš„çº¿ç¨‹å®‰å…¨ã€‚å®ƒè¡¨ç¤ºä¿®é¥°çš„åŒºåŸŸåªä¼šè®¿é—®ä¸€æ¬¡ï¼Œè¿™æ ·å¤šçº¿ç¨‹æƒ…å†µä¸‹ç±»ä¹Ÿåªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œç¡®ä¿äº† Objective-C ä¸­å•ä¾‹çš„åŸå­åŒ–ã€‚

```
+ (instancetype)sharedManager {
  static Manager *sharedManager = nil;
  static dispatch_once_t onceToken;
  dispatch_once(&onceToken, ^{
    sharedManager = [[Manager alloc] init];
   });
   return sharedManager;
}

```

*   dispatch_group ä¸€èˆ¬ç”¨äºå¤šä¸ªä»»åŠ¡åŒæ­¥ã€‚ä¸€èˆ¬ç”¨æ³•æ˜¯å½“å¤šä¸ªä»»åŠ¡å…³è”åˆ°åŒä¸€ä¸ªç¾¤ç»„ï¼ˆgroupï¼‰åï¼Œæ‰€æœ‰çš„ä»»åŠ¡åœ¨æ‰§è¡Œå®Œåæˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªç»Ÿä¸€çš„åç»­å·¥ä½œã€‚æ³¨æ„ dispatch_group_wait æ˜¯ä¸ªåŒæ­¥æ“ä½œï¼Œå®ƒä¼šé˜»å¡çº¿ç¨‹ã€‚

```
dispatch_group_t group = dispatch_group_create();

dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
  NSLog(@â€å¼€å§‹åšä»»åŠ¡1ï¼â€);
});

dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
  NSLog(@â€å¼€å§‹åšä»»åŠ¡2ï¼â€)
});

dispatch_group_notify(group, dispatch_get_main_queue(), ^{
   NSLog(@â€ä»»åŠ¡1å’Œä»»åŠ¡2éƒ½å®Œæˆäº†ï¼â€)
});

```

### 8.GCD ä¸­å…¨å±€ï¼ˆglobalï¼‰é˜Ÿåˆ—æœ‰å“ªå‡ ç§ä¼˜å…ˆçº§ï¼Ÿ

**å…³é”®è¯ï¼š#QoS**

å®˜æ–¹é“¾æ¥ï¼š[https://developer.apple.com/library/archive/documentation/Performance/Conceptual/EnergyGuide-iOS/PrioritizeWorkWithQoS.html](https://developer.apple.com/library/archive/documentation/Performance/Conceptual/EnergyGuide-iOS/PrioritizeWorkWithQoS.html)

é¦–å…ˆï¼Œå…¨å±€é˜Ÿåˆ—è‚¯å®šæ˜¯å¹¶å‘é˜Ÿåˆ—ã€‚å¦‚æœä¸æŒ‡å®šä¼˜å…ˆçº§ï¼Œå°±æ˜¯é»˜è®¤ï¼ˆdefaultï¼‰ä¼˜å…ˆçº§ã€‚å¦å¤–è¿˜æœ‰ backgroundï¼Œutilityï¼Œuser-Initiatedï¼Œunspecifiedï¼Œuser-Interactiveã€‚ä¸‹é¢æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºä»ä½åˆ°é«˜æ¥æ’åˆ—ï¼š

*   **Backgroundï¼š**ç”¨æ¥å¤„ç†ç‰¹åˆ«è€—æ—¶ï¼ˆå‡ åˆ†é’Ÿç”šè‡³ä¸Šå°æ—¶ï¼‰çš„åå°æ“ä½œï¼Œä¾‹å¦‚åŒæ­¥ã€å¤‡ä»½æ•°æ®ï¼›æ€§èƒ½æ–¹é¢ä¼˜å…ˆè€ƒè™‘ç”µé‡æ¶ˆè€—ã€‚

*   **Utilityï¼š**ç”¨æ¥å¤„ç†éœ€è¦ä¸€ç‚¹æ—¶é—´ï¼ˆå‡ åç§’åˆ°å‡ åˆ†é’Ÿï¼‰è€Œåˆä¸éœ€è¦ç«‹åˆ»è¿”å›ç»“æœçš„æ“ä½œã€‚ç‰¹åˆ«é€‚ç”¨äºå¼‚æ­¥æ“ä½œï¼Œä¾‹å¦‚ä¸‹è½½æˆ–æ˜¯è§£ç ç¼–ç æ•°æ®ï¼›æ€§èƒ½æ–¹é¢ä¼šç»¼åˆè€ƒè™‘ç”µé‡æ¶ˆè€—å’Œå³æ—¶åé¦ˆã€‚

*   **Defaultï¼š**é»˜è®¤ä¼˜å…ˆçº§ã€‚ä¸€èˆ¬æ¥è¯´å¼€å‘è€…åº”è¯¥æŒ‡å®šä¼˜å…ˆçº§ã€‚å±äºç‰¹æ®Šæƒ…å†µã€‚

*   **User-Initiatedï¼š**ç”¨æ¥å¤„ç†ç”¨æˆ·è§¦å‘çš„ã€éœ€è¦ç«‹åˆ»ï¼ˆå‡ ç§’ï¼‰è¿”å›ç»“æœçš„æ“ä½œã€‚æ¯”å¦‚æ‰“å¼€ç”¨æˆ·ç‚¹å‡»çš„æ–‡ä»¶ï¼›æ€§èƒ½æ–¹é¢ä¼˜å…ˆè€ƒè™‘å³æ—¶åé¦ˆã€‚

*   **User-Interactiveï¼š**ç”¨æ¥ç›¸åº”ç”¨æˆ·äº¤äº’æˆ–å±•ç°åŠ¨ç”»ã€‚å¦‚æœä¸åŠæ—¶å“åº”å°±å¯èƒ½é˜»å¡ä¸»çº¿ç¨‹çš„æ“ä½œï¼›æ€§èƒ½æ–¹é¢ä¼˜å…ˆè€ƒè™‘ç«‹åˆ»å“åº”ã€‚

*   **Unspecifiedï¼š**æœªç¡®å®šä¼˜å…ˆçº§ï¼Œç”±ç³»ç»Ÿæ ¹æ®ä¸åŒç¯å¢ƒæ¨æ–­ã€‚æ¯”å¦‚ä½¿ç”¨è¿‡æ—¶çš„ API ä¸æ”¯æŒä¼˜å…ˆçº§ï¼Œæ­¤æ—¶å°±å¯ä»¥è®¾å®šä¸ºæœªç¡®å®šä¼˜å…ˆçº§ã€‚å±äºç‰¹æ®Šæƒ…å†µã€‚

### 9.è¯•æ¯”è¾ƒä»¥ä¸‹ Operations ä¸­çš„å…³é”®è¯ï¼šOperationï¼ŒBlockOperationï¼ŒOperationQueue

**å…³é”®è¯ï¼š#Operation**

Operations æ˜¯ iOS ä¸­é™¤ GCD å¤–æœ‰ä¸€ç§å®ç°å¹¶å‘ç¼–ç¨‹çš„æ–¹å¼ã€‚å®ƒå°†å•ä¸ªä»»åŠ¡ç®—ä½œä¸€ä¸ª Operationï¼Œç„¶åæ”¾åœ¨ OperationQueue é˜Ÿåˆ—ä¸­è¿›è¡Œç®¡ç†å’Œè¿è¡Œã€‚å…¶ä¸­æœ€å¸¸ç”¨çš„ä¸‰ä¸ªå…³é”®è¯å°±æ˜¯ Operationï¼ŒBlockOperationï¼ŒOperationQueueã€‚

*   Operation æŒ‡ä»£ä¸€ç³»åˆ—å·¥ä½œæˆ–è€…ä»»åŠ¡ã€‚Operation æœ¬èº«æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬ä¸€èˆ¬é€šè¿‡é›†æˆå®ƒæ¥å®Œæˆè‡ªå®šä¹‰çš„å·¥ä½œã€‚æ¯ä¸ªå•ç‹¬çš„ Operation æœ‰ä¸ª 4 ç§çŠ¶æ€ï¼šå‡†å¤‡å°±ç»ªï¼ˆReadyï¼‰ï¼Œæ‰§è¡Œä¸­ï¼ˆExecutingï¼‰ï¼Œæš‚åœï¼ˆcancelledï¼‰ï¼Œå®Œæˆï¼ˆFinishedï¼‰ã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„å›¾ç‰‡è½¬åŒ–çš„ Operation å­ç±»ï¼š

```
class ImageFilterOperation: Operation {
  var inputImage: UIImage?
  var outputImage: UIImage?

  override func main() {
    outputImage = filter(image: inputImage)
  }
}

```

*   BlockOperation æ˜¯ç³»ç»Ÿå®šä¹‰çš„ä¸€ä¸ª Operation çš„å­ç±»ã€‚å®ƒæœ¬èº«åœ¨é»˜è®¤æƒé™çš„å…¨å±€é˜Ÿåˆ—ä¸Šè¿›è¡Œï¼Œè´Ÿè´£å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚å…¶ä¸­ä»»åŠ¡ä¹‹é—´äº’ä¸ä¾èµ–ï¼ŒåŒæ—¶ BlockOperation ä¹Ÿå¯ä»¥åƒ dispatch_group ä¸€æ ·åŒæ­¥ç®¡ç†å¤šä¸ªä»»åŠ¡ã€‚ä¾‹å¦‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š

```
let multiTasks = BlockOperation()

multiPrinter.completionBlock = {
  print("æ‰€æœ‰ä»»åŠ¡å®Œæˆ!")
}

multiTasks.addExecutionBlock {  print("ä»»åŠ¡1å¼€å§‹"); sleep(1) }
multiTasks.addExecutionBlock {  print("ä»»åŠ¡2å¼€å§‹"); sleep(2) }
multiTasks.addExecutionBlock {  print("ä»»åŠ¡3å¼€å§‹"); sleep(3) }

multiPrinter.start()

```

*   OperationQueue æ˜¯è´Ÿè´£å®‰æ’å’Œè¿è¡Œå¤šä¸ª Operation çš„é˜Ÿåˆ—ã€‚ä½†æ˜¯å®ƒå¹¶ä¸å±€é™äºå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—æ“ä½œã€‚å®ƒæä¾›äº†å¤šä¸ªæ¥å£å¯ä»¥å®ç°æš‚åœã€ç»§ç»­ã€ç»ˆæ­¢ã€ä¼˜å…ˆé¡ºåºã€ä¾èµ–ç­‰å¤æ‚æ“ä½œã€‚åŒæ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡è®¾ç½®å…¶ maxConcurrentOperationCount å±æ€§æ¥åŒºåˆ†å…¶æ˜¯ä¸²è¡Œè¿˜æ˜¯å¹¶å‘ã€‚ä¸‹é¢æ˜¯ç¤ºä¾‹ä»£ç ï¼š

```
Let multiTaskQueue = OperationQueue()

multiTaskQueue.addOperation { print("ä»»åŠ¡1å¼€å§‹"); sleep(1) }
multiTaskQueue.addOperation { print("ä»»åŠ¡2å¼€å§‹"); sleep(2) }
multiTaskQueue.addOperation { print("ä»»åŠ¡3å¼€å§‹"); sleep(3) }

multiTaskQueue.waitUntilAllOperationsAreFinished()

```

### 10.å¦‚ä½•åœ¨ OperationQueue ä¸­å–æ¶ˆæŸä¸ª Operation æ“ä½œ?

**å…³é”®è¯ï¼š#cancel() #isCancelled**

åœ¨ Operation æŠ½è±¡ç±»ä¸­ï¼Œæœ‰ä¸€ä¸ª cancel() æ–¹æ³•ï¼Œå®ƒåšçš„å”¯ä¸€ä¸€ä»¶äº‹æƒ…å°±æ˜¯å°† Operation çš„ isCancelled å±æ€§ä» false æ”¹ä¸º trueã€‚ç”±äºå®ƒå¹¶ä¸ä¼šçœŸæ­£å»æ·±å…¥ä»£ç å°†å…·ä½“æ‰§è¡Œçš„å·¥ä½œæš‚åœï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åˆ©ç”¨ isCancelled å±æ€§çš„å˜åŒ–æ¥æš‚åœ main() æ–¹æ³•ä¸­çš„å·¥ä½œã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸ªæ±‚å’Œæ•´å‹æ•°ç»„çš„æ“ä½œï¼Œå…¶å¯¹åº” Operation å¦‚ä¸‹ï¼š

```
class ArraySumOperation: Operation {
  let nums: [Int]
  var sum: Int

  init(nums: [Int]) {
    self.nums = nums
    self.sum = 0
    super.init()
  }

  override func main() {
    for num in nums {
      sum += num
    }
  }
}

```

å¦‚æœæˆ‘ä»¬è¦è¿è¡Œè¯¥ Operationï¼Œå°±åº”è¯¥å°†å…¶åŠ å…¥åˆ° OperationQueue ä¸­ï¼š

```
let queue = OperationQueue()
let sumOperation = ArraySumOperation(nums: Array(1...1000))

// ä¸€æ—¦å‡å¦‚åˆ°OperationQueueä¸­ï¼ŒOperationå°±å¼€å§‹æ‰§è¡Œ
queue.addOperation(sumOperation)

// æ‰“å°å‡º500500ï¼ˆ1+2+3+...+1000ï¼‰
sumOperation.completionBlock = { print(sumOperation.sum) }

```

å¦‚æœè¦å–æ¶ˆï¼Œæˆ‘ä»¬åº”è¯¥è°ƒç”¨ cancel() æ–¹æ³•ï¼Œè€Œå®ƒåªä¼šå°† isCancelled æ”¹æˆ falseï¼Œè€Œæˆ‘ä»¬è¦åˆ©ç”¨ isCancelled çš„çŠ¶æ€æ§åˆ¶ main() ä¸­çš„æ“ä½œï¼Œæ‰€ä»¥å¯å°† ArraySumOperation æ”¹æˆå¦‚ä¸‹ï¼š

```
class ArraySumOperation: Operation {
  let nums: [Int]
  var sum: Int

  init(nums: [Int]) {
    self.nums = nums 
    self.sum = 0
    super.init()
  }

  override func main() {  
    for num in nums {
      if isCancelled {
        return
      }
      sum += num
    }
  }
}

```

æ­¤æ—¶è¿è¡Œ Operationï¼Œå°±ä¼šå¾—åˆ°ä¸åŒç»“æœï¼š

```
let queue = OperationQueue()
let sumOperation = ArraySumOperation(nums: Array(1...1000))

// ä¸€æ—¦å‡å¦‚åˆ°OperationQueueä¸­ï¼ŒOperationå°±å¼€å§‹æ‰§è¡Œ
queue.addOperation(sumOperation)

sumOperation.cancel()

// sumOperationåœ¨å½»åº•å®Œæˆå‰å·²ç»æš‚åœï¼Œsumå€¼å°äº500500
sumOperation.completionBlock = { print(sumOperation.sum) }

```

åŒæ—¶ OperationQueue è¿˜æœ‰ cancelAllOperations() æ–¹æ³•å¯ä»¥è°ƒç”¨ï¼Œå®ƒç›¸å½“äºæ˜¯å¯¹äºæ‰€æœ‰åœ¨è¯¥é˜Ÿåˆ—ä¸Šå·¥ä½œçš„ Operationï¼Œéƒ½è°ƒç”¨å…¶ cancel() æ–¹æ³•ã€‚

### 11.è¯´è¯´åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¸»çº¿ç¨‹å’Œå…¶ä»–çº¿ç¨‹çš„ä½¿ç”¨åœºæ™¯

**å…³é”®è¯ï¼š#UI #è€—æ—¶**

ä¸»çº¿ç¨‹ä¸€èˆ¬ç”¨äºè´Ÿè´£ UI ç›¸å…³æ“ä½œï¼Œå¦‚ç»˜åˆ¶å›¾å±‚ã€å¸ƒå±€ã€å“åº”ç”¨æˆ·å“åº”ã€‚å¾ˆå¤š UIKit ç›¸å…³çš„æ§ä»¶å¦‚æœä¸åœ¨ä¸»çº¿ç¨‹æ“ä½œï¼Œä¼šäº§ç”ŸæœªçŸ¥æ•ˆæœã€‚Xcode ä¸­çš„ Main Thread Checker å¯ä»¥å°†ç›¸å…³é—®é¢˜æ£€æµ‹å‡ºæ¥å¹¶æŠ¥é”™ã€‚

å…¶ä»–çº¿ç¨‹ä¾‹å¦‚åå°çº¿ç¨‹ä¸€èˆ¬ç”¨æ¥å¤„ç†æ¯”è¾ƒè€—æ—¶çš„å·¥ä½œã€‚ç½‘ç»œè¯·æ±‚ã€æ•°æ®è§£æã€å¤æ‚è®¡ç®—ã€å›¾ç‰‡çš„ç¼–ç è§£ç ç®¡ç†ç­‰éƒ½å±äºè€—æ—¶çš„å·¥ä½œï¼Œåº”è¯¥æ”¾åœ¨å…¶ä»–çº¿ç¨‹å¤„ç†ã€‚å¦‚æœæ”¾åœ¨ä¸»çº¿ç¨‹ï¼Œç”±äºå…¶æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œä¼šç›´æ¥é˜»å¡ä¸»çº¿ç¨‹çš„ UI æ“ä½œï¼Œç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒã€‚

# æ¨èğŸ‘‡ï¼š

å¦‚æœä½ æ­£åœ¨è·³æ§½æˆ–è€…æ­£å‡†å¤‡è·³æ§½ä¸å¦¨åŠ¨åŠ¨å°æ‰‹ï¼Œæ·»åŠ ä¸€ä¸‹å’±ä»¬çš„äº¤æµç¾¤[**931 542 608**](https://jq.qq.com/?_wv=1027&k=cfVxrMAH)æ¥è·å–ä¸€ä»½è¯¦ç»†çš„å¤§å‚é¢è¯•èµ„æ–™ä¸ºä½ çš„è·³æ§½å¤šæ·»ä¸€ä»½ä¿éšœã€‚

![](https://upload-images.jianshu.io/upload_images/22877992-0bfc037cc50cae7d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

